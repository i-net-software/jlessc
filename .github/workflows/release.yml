name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.10.0, v1.11.0, etc.
      - '[0-9]+.[0-9]+.[0-9]+*'  # Also supports tags like 1.10.0, 1.11.0, etc.
      - '*-SNAPSHOT'  # Supports snapshot tags like v1.16.0-SNAPSHOT or 1.16.0-SNAPSHOT

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to create releases and upload assets
      id-token: write  # Required for OIDC if using
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog extraction
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag format: v1.10.0 or v1.10.0-SNAPSHOT -> 1.10.0 or 1.10.0-SNAPSHOT
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # Tag format: 1.10.0 or 1.10.0-SNAPSHOT -> 1.10.0 or 1.10.0-SNAPSHOT
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          
          # Check if this is a snapshot
          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            echo "is_snapshot=true" >> $GITHUB_OUTPUT
            echo "This is a snapshot release"
          else
            echo "is_snapshot=false" >> $GITHUB_OUTPUT
            echo "This is a release version"
          fi
      
      - name: Update version in gradle.properties
        run: |
          # Keep version as-is (including -SNAPSHOT if present)
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^version = .*/version = ${VERSION}/" gradle.properties
          cat gradle.properties
      
      - name: Build project
        run: ./gradlew -Djdk.tls.client.protocols="TLSv1,TLSv1.1,TLSv1.2" --stacktrace clean build -x test --no-daemon
        shell: bash
      
      - name: Publish to Maven Local
        run: ./gradlew publishToMavenLocal --no-daemon
        shell: bash
      
      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Extracting changelog for version: $VERSION"
          
          # Try to extract changelog section for this version
          # Look for version in CHANGELOG.md or README.md
          CHANGELOG=""
          
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG=$(awk -v version="$VERSION" '
              BEGIN { found=0; in_section=0 }
              /^# / || /^## / {
                if (in_section) exit
                if ($0 ~ "^# " version "$" || $0 ~ "^# " version " " || 
                    $0 ~ "^## " version "$" || $0 ~ "^## " version " ") {
                  found=1
                  in_section=1
                  next
                }
              }
              in_section { print }
            ' CHANGELOG.md)
          fi
          
          # If empty, use a default message
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release version $VERSION"
          fi
          
          # Escape for GitHub output (multiline)
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "Changelog extracted (first 200 chars):"
          echo "$CHANGELOG" | head -c 200
          echo ""
      
      - name: Create GitHub Release
        if: steps.version.outputs.is_snapshot == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Version ${{ steps.version.outputs.version }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.ref }}
          files: |
            build/libs/*.jar
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create GitHub Snapshot Release
        if: steps.version.outputs.is_snapshot == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Snapshot ${{ steps.version.outputs.version }}
          body: |
            ## Snapshot Version ${{ steps.version.outputs.version }}
            
            This is a snapshot build published to Maven Central snapshots repository.
            
            **Snapshot Repository**: https://oss.sonatype.org/content/repositories/snapshots/
          files: |
            build/libs/*.jar
          draft: false
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish to Maven Central (Sonatype)
        continue-on-error: true
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          if [[ "${{ steps.version.outputs.is_snapshot }}" == "true" ]]; then
            echo "Publishing snapshot to Sonatype..."
            ./gradlew publishToSonatype --no-daemon \
              -Psigning.key="$SIGNING_KEY" \
              -Psigning.password="$SIGNING_PASSWORD"
          else
            echo "Publishing release to Sonatype and closing staging repository..."
            ./gradlew publishToSonatype closeStagingRepositories --no-daemon \
              -Psigning.key="$SIGNING_KEY" \
              -Psigning.password="$SIGNING_PASSWORD"
          fi
        shell: bash

